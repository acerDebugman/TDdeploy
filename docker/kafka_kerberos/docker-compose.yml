services:
  # Kerberos KDC Server
  kerberos:
    image: rockylinux:8
    container_name: kafka-kerberos
    hostname: kerberos.example.com
    volumes:
      - ./kerberos/keytabs:/keytabs
      - ./kerberos/krb5.conf:/etc/krb5.conf:ro
      - ./kerberos/setup.sh:/setup.sh:ro
    ports:
      - "88:88/udp"
      - "88:88/tcp"
      - "749:749/tcp"
    networks:
      - kafka-kerberos-net
    command: /bin/bash /setup.sh
    healthcheck:
      test: ["CMD", "sh", "-c", "kadmin -p admin/admin@EXAMPLE.COM -w admin -q 'listprincs' 2>/dev/null | grep -q 'kafka'"]
      interval: 5s
      timeout: 10s
      retries: 20
      start_period: 60s

  # Zookeeper (no Kerberos)
  zookeeper:
    image: zookeeper:3.8
    container_name: kafka-zookeeper
    hostname: zookeeper
    environment:
      - ZOO_MY_ID=1
      - ZOO_SERVERS=server.1=zookeeper:2888:3888;2181
    ports:
      - "2181:2181"
    networks:
      - kafka-kerberos-net

  # Kafka with Kerberos/GSSAPI (broker-to-client and broker-to-broker only)
  kafka:
    image: wurstmeister/kafka:2.13-2.8.1
    container_name: kafka-broker
    hostname: kafka.example.com
    depends_on:
      kerberos:
        condition: service_healthy
      zookeeper:
        condition: service_started
    environment:
      - KAFKA_BROKER_ID=0
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_ZOOKEEPER_SASL_ENABLED=false
      - KAFKA_ADVERTISED_LISTENERS=SASL_PLAINTEXT://localhost:9092
      - KAFKA_LISTENERS=SASL_PLAINTEXT://:9092
      - KAFKA_SECURITY_INTER_BROKER_PROTOCOL=SASL_PLAINTEXT
      - KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL=GSSAPI
      - KAFKA_SASL_ENABLED_MECHANISMS=GSSAPI
      - KAFKA_SASL_KERBEROS_SERVICE_NAME=kafka
      - KAFKA_SASL_KERBEROS_KINIT_CMD=/usr/bin/kinit
      - KAFKA_OPTS=-Djava.security.auth.login.config=/etc/kafka/kafka-jaas.conf -Djava.security.krb5.conf=/etc/krb5.conf
      - KAFKA_AUTHORIZER_CLASS_NAME=kafka.security.authorizer.AclAuthorizer
      - KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND=true
      - KAFKA_SUPER_USERS=User:kafka;User:kafka-user
    volumes:
      - ./kafka/kafka-jaas.conf:/etc/kafka/kafka-jaas.conf:ro
      - ./kerberos/keytabs:/keytabs:ro
      - ./kerberos/krb5.conf:/etc/krb5.conf:ro
    ports:
      - "9092:9092"
    networks:
      - kafka-kerberos-net

  # Kafka Client
  kafka-client:
    image: wurstmeister/kafka:2.13-2.8.1
    container_name: kafka-client
    depends_on:
      - kafka
    environment:
      - KAFKA_OPTS=-Djava.security.krb5.conf=/etc/krb5.conf
    volumes:
      - ./kerberos/keytabs:/keytabs:ro
      - ./kerberos/krb5.conf:/etc/krb5.conf:ro
      - ./client/client-jaas.conf:/etc/kafka/client-jaas.conf:ro
    networks:
      - kafka-kerberos-net
    command: tail -f /dev/null

networks:
  kafka-kerberos-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/24
